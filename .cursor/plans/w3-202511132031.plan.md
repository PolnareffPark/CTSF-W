<!-- 9a93c5ab-08ec-4754-a148-7a9d1165d777 f542921c-02f4-449f-b29f-066e0fce424a -->
# W3 _W3PerturbWrapper **getattr** 버그 수정 플랜

## 문제 요약

현재 `__getattr__` 구현은 `name == "base"`일 때 `getattr(base, "base")`를 시도하여 AttributeError를 발생시킵니다. 이는 `forward()` 내에서 `self.base`를 접근할 때 치명적인 오류를 야기합니다.

## 해결 방안 (2가지 옵션)

### 옵션 A: `__getattr__` 메서드 수정 (권장)

**장점:**

- `forward()` 코드를 수정하지 않아도 됨
- 가장 직관적이고 명확한 해결책
- 다른 코드에서도 `self.base`를 자연스럽게 사용 가능

**수정 내용:**

```python
def __getattr__(self, name: str):
    """
    래퍼에 없는 속성은 항상 내부 base 모듈로 위임.
    단, 'base' 자체를 요청하면 base 모듈을 직접 반환.
    """
    modules = object.__getattribute__(self, "_modules")
    base = modules.get("base")
    if base is None:
        raise AttributeError(
            f"{self.__class__.__name__} has no registered 'base' submodule"
        )
    # 'base' 속성 자체를 요청하면 base 모듈을 반환
    if name == "base":
        return base
    # 그 외 속성은 base에 위임
    return getattr(base, name)
```

**위치:** `experiments/w3_experiment.py` line 190-199

## 권장 사항

**옵션 A를 강력히 권장**합니다:

1. 더 pythonic하고 직관적
2. `forward()` 외의 다른 메서드에서도 `self.base` 사용 가능
3. 코드 가독성 향상
4. nn.Module의 일반적인 패턴과 일치

## 검증 계획

### 1단계: 수정 후 구문 검사

```bash
python -m py_compile experiments/w3_experiment.py
```

### 2단계: 개선된 자체 검증 코드 실행

```python
import torch
import torch.nn as nn
from experiments.w3_experiment import _W3PerturbWrapper

class Dummy(nn.Module):
    def __init__(self):
        super().__init__()
        self.xhconv_blks = nn.ModuleList([nn.Conv1d(1, 1, 3)])
    def forward(self, x): 
        return x

base = Dummy()
wrap = _W3PerturbWrapper(base, mode="none", dataset="ETTm2", perturb_cfg=None)

# 1) 속성 위임 검증
assert wrap.xhconv_blks is base.xhconv_blks, "xhconv_blks delegation failed"

# 2) base 속성 직접 접근 검증
assert wrap.base is base, "base access failed"

# 3) forward 검증 (__dict__ 우회 없이)
x = torch.randn(2, 1, 16)
_ = wrap(x)  # 예외 없어야 함

print("✓ All checks passed")
```

## 예상 결과

- 수정 전: `AttributeError: 'HybridTS' object has no attribute 'base'` 발생
- 수정 후: 정상 실행, 33.6분 이상 학습 후 평가 단계 정상 완료

## 추가 개선 사항

### `unwrap()` 메서드도 개선 가능

현재 `unwrap()` 메서드도 `_modules`에 직접 접근하는데, 수정 후에는 더 간단하게:

```python
def unwrap(self) -> nn.Module:
    """내부 원본 모델을 반환."""
    return self.base  # __getattr__을 통해 안전하게 접근
```

**위치:** `experiments/w3_experiment.py` line 201-209

## 구현 순서

1. `__getattr__` 메서드 수정 (line 190-199)
2. (선택) `unwrap()` 메서드 간소화 (line 201-209)
3. 구문 검사 실행
4. 개선된 자체 검증 코드 실행
5. 실제 실험 smoke test

## 예상 소요 시간

- 코드 수정: 5분
- 검증: 5분
- Smoke test: 40분 (학습 포함)
- 총: 50분