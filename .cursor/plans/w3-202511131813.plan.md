<!-- 9a93c5ab-08ec-4754-a148-7a9d1165d777 c3114ff2-3bf8-4cec-9849-dcda8d1fcfcc -->
# W3 Experiment 코드 수정 플랜

## 발견된 치명적 문제들

### 1. _create_model 메서드 누락 ⚠️ CRITICAL

**문제**:

- BaseExperiment.__init__에서 `self.model = self._create_model()` 호출
- W3Experiment에 _create_model 메서드가 없음
- BaseExperiment._create_model은 `raise NotImplementedError`

**결과**: 인스턴스화 시 즉시 실패

**해결**:

```python
def _create_model(self):
    """BaseExperiment가 요구하는 모델 생성"""
    from models.ctsf_model import HybridTS
    return HybridTS(self.cfg, self.n_vars)
```

### 2. save_w3_forest_detail_row 호출 오류 ⚠️ CRITICAL

**현재 코드** (line ~230):

```python
save_w3_forest_detail_row(
    ctx={...},
    rmse_real=rmse_real,
    mae_real=mae_real,
)
```

**함수 시그니처**:

```python
def save_w3_forest_detail_row(
    ctx: Dict[str,Any],
    rmse_real: float, mae_real: float,
    detail_csv: str | Path,  # ← 필수 인자 누락!
) -> None:
```

**결과**: TypeError - missing required argument 'detail_csv'

**해결**:

```python
from pathlib import Path
fdir = Path("results") / f"results_{EXP_TAG}" / dataset / "forest_plot"
fdir.mkdir(parents=True, exist_ok=True)
save_w3_forest_detail_row(
    ctx={...},
    rmse_real=rmse_real,
    mae_real=mae_real,
    detail_csv=fdir / "forest_plot_detail.csv",
)
```

### 3. compute_and_save_w3_gate_tod_heatmap 호출 오류 ⚠️ CRITICAL

**현재 코드** (line ~240):

```python
compute_and_save_w3_gate_tod_heatmap(
    ctx={...},
    hooks_data=hooks,
    dataset=dataset,
)
```

**함수 시그니처**:

```python
def compute_and_save_w3_gate_tod_heatmap(
    ctx: Dict[str,Any],
    hooks_data: Dict[str,Any],
    tod_vec: np.ndarray,      # ← 누락!
    dataset: str,
    out_dir: str | Path,       # ← 누락!
    amp_method: str = "range",
) -> None:
```

**결과**: TypeError - missing required arguments

**해결**:

```python
from data.dataset import build_test_tod_vector
tod_vec = build_test_tod_vector(self.cfg)
hdir = Path("results") / f"results_{EXP_TAG}" / dataset / "gate_tod_heatmap"
hdir.mkdir(parents=True, exist_ok=True)
compute_and_save_w3_gate_tod_heatmap(
    ctx={...},
    hooks_data=hooks,
    tod_vec=tod_vec,
    dataset=dataset,
    out_dir=hdir,
)
```

### 4. compute_and_save_w3_gate_distribution 호출 오류 ⚠️ CRITICAL

**현재 코드** (line ~250):

```python
compute_and_save_w3_gate_distribution(
    ctx={...},
    hooks_data=hooks,
)
```

**함수 시그니처**:

```python
def compute_and_save_w3_gate_distribution(
    ctx: Dict[str,Any],
    hooks_data: Dict[str,Any],
    out_dir: str | Path,  # ← 누락!
) -> None:
```

**결과**: TypeError - missing required argument 'out_dir'

**해결**:

```python
ddir = Path("results") / f"results_{EXP_TAG}" / dataset / "gate_distribution"
ddir.mkdir(parents=True, exist_ok=True)
compute_and_save_w3_gate_distribution(
    ctx={...},
    hooks_data=hooks,
    out_dir=ddir,
)
```

### 5. rebuild_w3_forest_summary 호출 오류 ⚠️ CRITICAL

**현재 코드** (line ~270):

```python
rebuild_w3_forest_summary(group_keys=("experiment_type", "dataset", "horizon"))
```

**함수 시그니처**:

```python
def rebuild_w3_forest_summary(
    detail_csv: str | Path,          # ← 누락!
    summary_csv: str | Path,         # ← 누락!
    gate_tod_summary_csv: Optional[str | Path] = None,
    group_keys: Tuple[str, ...] = ("experiment_type","dataset","horizon"),
) -> None:
```

**결과**: TypeError - missing required arguments

**해결**:

```python
fdir = Path("results") / f"results_{EXP_TAG}" / dataset / "forest_plot"
hdir = Path("results") / f"results_{EXP_TAG}" / dataset / "gate_tod_heatmap"
rebuild_w3_forest_summary(
    detail_csv=fdir / "forest_plot_detail.csv",
    summary_csv=fdir / "forest_plot_summary.csv",
    gate_tod_summary_csv=hdir / "gate_tod_heatmap_summary.csv",
    group_keys=("experiment_type","dataset","horizon")
)
```

### 6. rebuild_w3_perturb_delta_bar 호출 오류 ⚠️ CRITICAL

**현재 코드** (line ~271):

```python
rebuild_w3_perturb_delta_bar(group_keys=("experiment_type", "dataset", "horizon"))
```

**함수 시그니처**:

```python
def rebuild_w3_perturb_delta_bar(
    results_csv: str | Path,   # ← 누락!
    detail_csv: str | Path,    # ← 누락!
    summary_csv: str | Path,   # ← 누락!
) -> None:
# group_keys 인자 없음!
```

**결과**: TypeError - unexpected keyword argument 'group_keys'

**해결**:

```python
rebuild_w3_perturb_delta_bar(
    results_csv=Path("results") / f"results_{EXP_TAG}.csv",
    detail_csv=Path("results") / f"results_{EXP_TAG}" / dataset / "perturb_delta_bar" / "perturb_delta_bar_detail.csv",
    summary_csv=Path("results") / f"results_{EXP_TAG}" / dataset / "perturb_delta_bar" / "perturb_delta_bar_summary.csv",
)
```

### 7. results_W3.csv 저장 로직 누락 ⚠️ CRITICAL

**문제**:

- 기존 코드는 `_append_or_update_results`로 results_W3.csv에 행 추가
- 새 코드에는 이 로직이 완전히 누락됨
- BaseExperiment.save_results는 있지만 W3 특화 지표를 포함하지 않음

**결과**: results_W3.csv에 데이터가 저장되지 않음

**해결**:

```python
# _after_eval_save 내부에 추가
import pandas as pd
import numpy as np

def _append_or_update_results(csv_path, row, subset):
    path = Path(csv_path)
    path.parent.mkdir(parents=True, exist_ok=True)
    new = pd.DataFrame([row])
    if path.exists():
        old = pd.read_csv(path)
        for c in new.columns:
            if c not in old.columns: old[c] = np.nan
        for c in old.columns:
            if c not in new.columns: new[c] = np.nan
        df = pd.concat([old, new], ignore_index=True)
        df.drop_duplicates(subset=subset, keep="last", inplace=True)
        tmp = path.with_suffix(path.suffix + ".tmp")
        df.to_csv(tmp, index=False)
        tmp.replace(path)
    else:
        new.to_csv(path, index=False)

row = {
    "dataset": dataset, "horizon": horizon, "seed": seed, "mode": mode,
    "model_tag": model_tag, "experiment_type": EXP_TAG,
    "mse_real": float(direct.get("mse_real", np.nan)),
    "rmse": float(rmse_real), "mae": float(mae_real),
    "cg_pearson_mean": direct.get("cg_pearson_mean", np.nan),
    "cg_spearman_mean": direct.get("cg_spearman_mean", np.nan),
    "cg_dcor_mean": direct.get("cg_dcor_mean", np.nan),
    "cg_event_gain": direct.get("cg_event_gain", np.nan),
    "cg_event_hit": direct.get("cg_event_hit", np.nan),
    "cg_maxcorr": direct.get("cg_maxcorr", np.nan),
    "cg_bestlag": direct.get("cg_bestlag", np.nan),
    "gc_kernel_tod_dcor": direct.get("gc_kernel_tod_dcor", np.nan),
    "gc_feat_tod_dcor": direct.get("gc_feat_tod_dcor", np.nan),
    "gc_feat_tod_r2": direct.get("gc_feat_tod_r2", np.nan),
    "gc_kernel_feat_dcor": direct.get("gc_kernel_feat_dcor", np.nan),
    "gc_kernel_feat_align": direct.get("gc_kernel_feat_align", np.nan),
}
_append_or_update_results(
    Path("results") / f"results_{EXP_TAG}.csv",
    row,
    subset=["dataset","horizon","seed","mode","model_tag","experiment_type"]
)
```

## 추가 검토 사항

### 8. **getattr** 구현 검토

**현재 코드**:

```python
def __getattr__(self, name: str):
    try:
        return super().__getattr__(name)
    except AttributeError:
        base = super().__getattribute__("base")
        if hasattr(base, name):
            return getattr(base, name)
        raise AttributeError(...)
```

**잠재적 문제**:

- `super().__getattribute__("base")`가 실패하면?
- 무한 재귀 가능성은?

**검증 필요**: 실제 테스트로 확인

### 9. tod_vec가 None일 때 처리

**현재 코드**:

```python
try:
    from data.dataset import build_test_tod_vector
    tod_vec = build_test_tod_vector(self.cfg)
except Exception:
    tod_vec = None
```

**문제**: compute_and_save_w3_gate_tod_heatmap은 tod_vec가 필수 인자

- None을 전달하면 함수 내부에서 처리하는지 확인 필요

**해결**: w3_plotting_metrics.py 확인 결과 _tod_index_from_vec에서 처리

### 10. import 누락 확인

**필요한 import**:

- `from pathlib import Path` ← 누락
- `import numpy as np` ← 누락
- `import pandas as pd` ← 누락 (results 저장용)
- `from models.ctsf_model import HybridTS` ← 누락

## 수정 계획 요약

### Phase 1: 필수 import 추가

```python
from pathlib import Path
import numpy as np
import pandas as pd
from models.ctsf_model import HybridTS
from data.dataset import build_test_tod_vector
```

### Phase 2: _create_model 메서드 추가

```python
def _create_model(self):
    """BaseExperiment가 요구하는 모델 생성"""
    return HybridTS(self.cfg, self.n_vars)
```

### Phase 3: _after_eval_save 메서드 전면 수정

1. 파일 경로 생성
2. save_w3_forest_detail_row에 detail_csv 추가
3. tod_vec 생성
4. compute_and_save_w3_gate_tod_heatmap에 tod_vec, out_dir 추가
5. compute_and_save_w3_gate_distribution에 out_dir 추가
6. results_W3.csv 저장 로직 추가

### Phase 4: run 메서드 수정

1. rebuild_w3_forest_summary에 필수 인자 추가
2. rebuild_w3_perturb_delta_bar에 필수 인자 추가, group_keys 제거

## 검증 계획

### 1. 구문 검사

```bash
python -m py_compile experiments/w3_experiment.py
```

### 2. Import 검사

```bash
python -c "from experiments.w3_experiment import W3Experiment; print('OK')"
```

### 3. 인스턴스화 검사

```bash
python -c "
from experiments.w3_experiment import W3Experiment
cfg = {'experiment_type': 'W3', 'csv_path': 'datasets/ETTm2.csv', ...}
exp = W3Experiment(cfg)
print('OK')
"
```

### 4. 실제 실행 테스트

```bash
python main.py --experiment W3 --dataset ETTm2 --horizon 96 --seed 42 --mode none
```

## 우선순위

| 순위 | 문제 | 중요도 | 영향 |

|------|------|--------|------|

| 1 | _create_model 누락 | CRITICAL | 인스턴스화 불가 |

| 2 | 함수 호출 인자 누락 | CRITICAL | 실행 불가 |

| 3 | results_W3.csv 저장 누락 | HIGH | 데이터 손실 |

| 4 | import 누락 | HIGH | 실행 불가 |

| 5 | **getattr** 검증 | MEDIUM | 잠재적 재귀 |

## 예상 소요 시간

- 코드 수정: 30분
- 테스트: 10분
- 총 40분