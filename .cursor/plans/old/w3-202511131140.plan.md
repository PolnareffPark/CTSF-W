<!-- 9a93c5ab-08ec-4754-a148-7a9d1165d777 96a11e03-d8d6-415b-a770-662b5c42772d -->
# W3 실험 코드 오류 수정 및 검증

## 발견된 주요 문제점

### 1. 치명적 오류 (즉시 수정 필요)

#### A. run_single()이 실행되지 않음

- **위치**: `experiments/w3_experiment.py` line 338
- **문제**: main.py와 run_suite.py에서 `exp.run()`을 호출하지만, W3Experiment는 run() 메서드를 오버라이드하지 않음
- **결과**: BaseExperiment.run()이 실행되어 W3 특화 로직(_after_eval_save, rebuild_w3_forest_summary 등)이 전혀 실행되지 않음
- **증거**: W2Experiment는 run()을 오버라이드하여 _after_eval_save를 호출함 (line 432-462)
- **수정**: `def run_single(self):` → `def run(self):`로 변경

#### B. self.fit() 호출 오류

- **위치**: `experiments/w3_experiment.py` line 351
- **문제**: BaseExperiment에는 fit() 메서드가 없고 train() 메서드만 있음
- **결과**: AttributeError 발생 예상
- **수정**: `self.fit()` → `self.train()`

#### C. HybridTS 생성 시 인자 부족

- **위치**: `experiments/w3_experiment.py` line 231
- **문제**: `return HybridTS(self.cfg)` - n_vars 인자 누락
- **증거**: 
  - HybridTS.__init__는 (cfg, n_vars) 두 인자 요구 (models/ctsf_model.py line 201)
  - W1/W2는 모두 `HybridTS(self.cfg, self.n_vars)` 형태로 호출
- **결과**: TypeError 발생 예상
- **수정**: `return HybridTS(self.cfg, self.n_vars)`

### 2. 잠재적 문제 (검토 필요)

#### D. model_tag 추출 문제

- **위치**: `experiments/w3_experiment.py` line 346
- **문제**: `getattr(self.model, "model_tag", "HyperConv")`
- **상황**: self.model은 _W3PerturbWrapper로 감싸져 있음 (line 226)
- **가능성**: wrapper에 model_tag 속성이 없을 경우 항상 "HyperConv" 반환
- **대안**: `getattr(self.model.base, "model_tag", "HyperConv")` 또는 wrapper에 **getattr** 추가

#### E. BaseExperiment.cleanup 호출

- **현재 상태**: run_single()의 finally 블록에 cleanup() 호출이 있음 (line 357-358)
- **문제**: run_single()이 실행되지 않으므로 cleanup도 호출되지 않음
- **확인**: BaseExperiment.run()은 자체 finally 블록에서 cleanup 호출 (base_experiment.py line 349-350)
- **결론**: run_single() → run()으로 변경하면 cleanup은 정상 작동

### 3. 교란 로직 검증 필요

#### F. _W3PerturbWrapper.forward() 동작

- **의도**: training=True일 때만 교란 적용 (line 190)
- **검증 필요**: 
  - model.train() / model.eval() 모드가 wrapper에 전달되는지
  - 첫 번째 텐서 감지 로직이 올바른지 (line 195-203)
  - 시간축 감지가 정확한지 (_find_time_axis)

#### G. TOD bin 계산 로직

- **기존 문제**: tod_bins=12032 같은 비정상 값
- **원인 가능성**:
  - hooks_data가 비어있거나 gate_outputs가 없음
  - 교란이 실행되지 않아 none/tod_shift/smooth가 모두 동일
  - _collect_gate_arrays_from_hooks가 None 반환
- **해결**: 위 1A-1C 수정으로 자연스럽게 해결될 가능성 높음

## 수정 계획

### Phase 1: 치명적 오류 수정 (experiments/w3_experiment.py)

1. line 338: `def run_single(self):` → `def run(self):`
2. line 340 주석 수정: "run_suite가... 호출한다" → "main.py와 run_suite.py에서 호출됨"
3. line 351: `self.fit()` → `self.train()`
4. line 231: `return HybridTS(self.cfg)` → `return HybridTS(self.cfg, self.n_vars)`

### Phase 2: model_tag 추출 개선

**옵션 A: wrapper에 getattr 추가**

```python
class _W3PerturbWrapper(nn.Module):
    # ... 기존 코드 ...
    
    def __getattr__(self, name):
        # nn.Module의 내부 속성은 그대로
        if name in ['base', 'cfg', 'mode', 'seq_len', 'roll_min', 'roll_max', 'smooth_kernel']:
            return super().__getattr__(name)
        # 나머지는 base 모델로 위임
        try:
            return getattr(self.base, name)
        except AttributeError:
            return super().__getattr__(name)
```

**옵션 B: run()에서 직접 base 참조**

```python
model_tag = getattr(self.model.base, "model_tag", "HyperConv")
```

**추천**: 옵션 B (더 명확하고 안전함)

### Phase 3: 검증

1. w3_metrics.py: compute_w3_metrics는 사용되지 않음 확인 (all_metrics.py line 37에서 빈 dict 반환)
2. w3_plotting_metrics.py: 함수 시그니처 확인

   - compute_and_save_w3_gate_tod_heatmap: 모든 인자 정상
   - compute_and_save_w3_gate_distribution: 모든 인자 정상
   - save_w3_forest_detail_row: 모든 인자 정상
   - rebuild_w3_forest_summary: 모든 인자 정상
   - rebuild_w3_perturb_delta_bar: 모든 인자 정상

## 교란 강도 평가

### tod_shift (ETTm2)

- roll 범위: 4-12 스텝
- ETTm2: 15분 단위 → 1-3시간 shift
- **평가**: 적절함 (하루 주기 96스텝 대비 4-12%의 위상 변화)

### smooth (ETTh2)

- 커널: [1,4,6,4,1] (가중 평균)
- 5-포인트 평활화
- **평가**: 적절함 (피크 완화 효과, 급격한 변화 제거)

## 예상 결과

수정 후 기대 효과:

1. none/tod_shift/smooth 모드별로 다른 성능 지표 산출
2. gate_tod_heatmap에서 정상적인 tod_bins 값 (ETTm2=96, ETTh2=24)
3. perturb_delta_bar에서 0이 아닌 delta 값 산출
4. forest_plot에서 모드별 차이 확인
5. pt 체크포인트 정상 정리

## 추가 고려사항

### wrapper의 training 모드 전환

- BaseExperiment.train()에서 model.train() 호출 확인 필요
- BaseExperiment.evaluate_test()에서 model.eval() 호출 확인 필요
- direct_evidence.py의 evaluate_with_direct_evidence에서 model.eval() 호출됨 (line 32)

### 데이터 로더의 교란 독립성

- 교란은 forward 단계에서 적용되므로 DataLoader와 독립적
- 평가 시 model.eval()로 자동 비활성화되어 깨끗한 데이터로 평가됨