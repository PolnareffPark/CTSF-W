<!-- 9a93c5ab-08ec-4754-a148-7a9d1165d777 ddc25806-0fe6-4fac-8bee-a5311b920266 -->
# W3 Plotting Metrics 치명적 버그 수정 플랜

## 검토 결과 요약

### 수정 완료된 부분 ✓

1. **compute_and_save_w3_gate_tod_heatmap 함수 시그니처**: 올바르게 수정됨 (line 152-290)
2. **중복 함수 제거**: `_append_or_update_row`, `_append_or_update_rows` 중복 제거 완료
3. **_atomic_write vs _atomic_write_csv**: `_atomic_write` 제거 완료, `_atomic_write_csv`만 사용

### 발견된 치명적 결함 ⚠️

---

## 치명적 결함: _atomic_write_csv 매개변수 순서 불일치 (CRITICAL)

### 문제 위치

`utils/experiment_plotting_metrics/w3_plotting_metrics.py`

### 함수 시그니처 (Line 22)

```python
def _atomic_write_csv(path: str | Path, df: pd.DataFrame) -> None:
    """Atomic CSV write (single temp file, then replace)."""
    path = _ensure_dir(path)
    tmp = path.with_suffix(path.suffix + ".tmp")
    df.to_csv(tmp, index=False)
    tmp.replace(path)
```

**올바른 순서**: `_atomic_write_csv(path, df)`

### 문제 발생 위치

| Line | 함수 | 호출 코드 | 순서 | 상태 |

|------|------|-----------|------|------|

| 49 | `_append_or_update_row` | `_atomic_write_csv(path, out)` | `(path, df)` | ✓ 올바름 |

| 70 | `_append_or_update_rows` | `_atomic_write_csv(path, out)` | `(path, df)` | ✓ 올바름 |

| 390 | `rebuild_w3_forest_summary` | `_atomic_write_csv(out, _ensure_dir(summary_csv))` | `(df, path)` | ✗ **잘못됨** |

| 407-409 | `rebuild_w3_perturb_delta_bar` | `_atomic_write_csv(pd.DataFrame(...), _ensure_dir(detail_csv))` | `(df, path)` | ✗ **잘못됨** |

| 411-413 | `rebuild_w3_perturb_delta_bar` | `_atomic_write_csv(pd.DataFrame(...), _ensure_dir(summary_csv))` | `(df, path)` | ✗ **잘못됨** |

| 482 | `rebuild_w3_perturb_delta_bar` | `_atomic_write_csv(D, _ensure_dir(detail_csv))` | `(df, path)` | ✗ **잘못됨** |

| 489 | `rebuild_w3_perturb_delta_bar` | `_atomic_write_csv(S, _ensure_dir(summary_csv))` | `(df, path)` | ✗ **잘못됨** |

| 531 | `save_w3_window_errors_detail` | `_atomic_write_csv(detail_path, df)` | `(path, df)` | ✓ 올바름 |

**요약**: 총 8개 호출 중 5개가 잘못된 순서를 사용하고 있습니다.

### 에러 발생 양상

**실행 시 에러**:

```python
# Line 390 실행 시
_atomic_write_csv(out, _ensure_dir(summary_csv))
# out은 pd.DataFrame, _ensure_dir(summary_csv)는 Path

# _atomic_write_csv 내부 (line 24)에서:
path = _ensure_dir(path)  # path = out (DataFrame!)
# AttributeError: 'DataFrame' object has no attribute 'parent'
# 또는
# TypeError: expected str, bytes or os.PathLike object, not DataFrame
```

### 영향

- `rebuild_w3_forest_summary` 실행 시 즉시 실패
- `rebuild_w3_perturb_delta_bar` 실행 시 즉시 실패
- W3 실험 후 요약 파일 생성 단계에서 완전 실패
- **실험 결과 데이터는 수집되지만 요약/집계가 불가능**

---

## 수정 방안

### 해결 전략

**모든 호출을 `_atomic_write_csv(path, df)` 순서로 통일**

이유:

1. 함수 시그니처가 `(path, df)` 순서로 정의됨
2. pandas의 `to_csv(path, ...)` 관례와 일치
3. 3개 호출이 이미 올바른 순서를 사용 중

---

## 구현 단계

### Phase 1: rebuild_w3_forest_summary 수정 (CRITICAL)

**파일**: `utils/experiment_plotting_metrics/w3_plotting_metrics.py`

**Line 388-390**

**수정 전**:

```python
    if out_rows:
        out = pd.DataFrame(out_rows)
        _atomic_write_csv(out, _ensure_dir(summary_csv))
```

**수정 후**:

```python
    if out_rows:
        out = pd.DataFrame(out_rows)
        _atomic_write_csv(_ensure_dir(summary_csv), out)
```

**또는 (더 깔끔)**:

```python
    if out_rows:
        out = pd.DataFrame(out_rows)
        _atomic_write_csv(summary_csv, out)  # _ensure_dir는 함수 내부에서 호출
```

---

### Phase 2: rebuild_w3_perturb_delta_bar 수정 (CRITICAL)

**파일**: `utils/experiment_plotting_metrics/w3_plotting_metrics.py`

**Step 2.1**: Line 407-414 수정

**수정 전**:

```python
    def _emit_empties():
        _atomic_write_csv(
            pd.DataFrame(columns=["experiment_type","dataset","horizon","seed","perturbation","metric","delta"]),
            _ensure_dir(detail_csv)
        )
        _atomic_write_csv(
            pd.DataFrame(columns=["experiment_type","dataset","horizon","perturbation","metric","delta_mean","n"]),
            _ensure_dir(summary_csv)
        )
```

**수정 후**:

```python
    def _emit_empties():
        _atomic_write_csv(
            detail_csv,
            pd.DataFrame(columns=["experiment_type","dataset","horizon","seed","perturbation","metric","delta"])
        )
        _atomic_write_csv(
            summary_csv,
            pd.DataFrame(columns=["experiment_type","dataset","horizon","perturbation","metric","delta_mean","n"])
        )
```

**Step 2.2**: Line 479-489 수정

**수정 전**:

```python
    D = pd.DataFrame(detail_rows) if detail_rows else pd.DataFrame(
        columns=["experiment_type","dataset","horizon","seed","perturbation","metric","delta"]
    )
    _atomic_write_csv(D, _ensure_dir(detail_csv))

    if not D.empty:
        S = (D.groupby(["experiment_type","dataset","horizon","perturbation","metric"], as_index=False)
               .agg(delta_mean=("delta","mean"), n=("delta","size")))
    else:
        S = pd.DataFrame(columns=["experiment_type","dataset","horizon","perturbation","metric","delta_mean","n"])
    _atomic_write_csv(S, _ensure_dir(summary_csv))
```

**수정 후**:

```python
    D = pd.DataFrame(detail_rows) if detail_rows else pd.DataFrame(
        columns=["experiment_type","dataset","horizon","seed","perturbation","metric","delta"]
    )
    _atomic_write_csv(detail_csv, D)

    if not D.empty:
        S = (D.groupby(["experiment_type","dataset","horizon","perturbation","metric"], as_index=False)
               .agg(delta_mean=("delta","mean"), n=("delta","size")))
    else:
        S = pd.DataFrame(columns=["experiment_type","dataset","horizon","perturbation","metric","delta_mean","n"])
    _atomic_write_csv(summary_csv, S)
```

---

### Phase 3: 검증 (REQUIRED)

**Step 3.1**: 구문 검사

```bash
python -m py_compile utils/experiment_plotting_metrics/w3_plotting_metrics.py
```

**Step 3.2**: Import 검사

```bash
python -c "from utils.experiment_plotting_metrics.w3_plotting_metrics import rebuild_w3_forest_summary, rebuild_w3_perturb_delta_bar; print('OK')"
```

**Step 3.3**: 단위 테스트 스크립트

```python
#!/usr/bin/env python3
"""Test _atomic_write_csv call signatures"""
import tempfile
import pandas as pd
from pathlib import Path
from utils.experiment_plotting_metrics.w3_plotting_metrics import _atomic_write_csv

# 테스트 디렉토리 생성
with tempfile.TemporaryDirectory() as tmpdir:
    test_path = Path(tmpdir) / "test.csv"
    test_df = pd.DataFrame({"a": [1, 2], "b": [3, 4]})
    
    # 올바른 호출: (path, df)
    try:
        _atomic_write_csv(test_path, test_df)
        assert test_path.exists(), "File should be created"
        print("✓ _atomic_write_csv(path, df) works correctly")
    except Exception as e:
        print(f"✗ Failed: {e}")
        exit(1)
    
    # 잘못된 호출: (df, path) - 에러 발생해야 함
    test_path2 = Path(tmpdir) / "test2.csv"
    try:
        _atomic_write_csv(test_df, test_path2)
        print("✗ _atomic_write_csv(df, path) should fail but didn't!")
        exit(1)
    except (AttributeError, TypeError) as e:
        print(f"✓ _atomic_write_csv(df, path) correctly fails: {type(e).__name__}")

print("\n✓ All signature tests passed!")
```

**Step 3.4**: 실제 함수 테스트

```python
#!/usr/bin/env python3
"""Test rebuild functions with dummy data"""
import tempfile
import pandas as pd
from pathlib import Path
from utils.experiment_plotting_metrics.w3_plotting_metrics import (
    rebuild_w3_forest_summary,
    rebuild_w3_perturb_delta_bar
)

with tempfile.TemporaryDirectory() as tmpdir:
    tmpdir = Path(tmpdir)
    
    # 1. Test rebuild_w3_forest_summary
    detail_csv = tmpdir / "forest_detail.csv"
    summary_csv = tmpdir / "forest_summary.csv"
    
    # Create dummy detail data
    detail_data = pd.DataFrame({
        "experiment_type": ["W3"] * 6,
        "dataset": ["ETTm2"] * 6,
        "horizon": [96] * 6,
        "seed": [42, 42, 43, 43, 44, 44],
        "mode": ["none", "tod_shift", "none", "tod_shift", "none", "smooth"],
        "model_tag": ["CTSF"] * 6,
        "rmse_real": [0.5, 0.6, 0.5, 0.58, 0.5, 0.55],
        "mae_real": [0.4, 0.48, 0.4, 0.46, 0.4, 0.44],
    })
    detail_data.to_csv(detail_csv, index=False)
    
    try:
        rebuild_w3_forest_summary(detail_csv, summary_csv)
        assert summary_csv.exists(), "Summary file should be created"
        print("✓ rebuild_w3_forest_summary works")
    except Exception as e:
        print(f"✗ rebuild_w3_forest_summary failed: {e}")
        import traceback
        traceback.print_exc()
        exit(1)
    
    # 2. Test rebuild_w3_perturb_delta_bar
    results_csv = tmpdir / "results_W3.csv"
    delta_detail = tmpdir / "delta_detail.csv"
    delta_summary = tmpdir / "delta_summary.csv"
    
    # Create dummy results data
    results_data = pd.DataFrame({
        "experiment_type": ["W3"] * 4,
        "dataset": ["ETTm2"] * 4,
        "horizon": [96] * 4,
        "seed": [42, 42, 43, 43],
        "mode": ["none", "tod_shift", "none", "tod_shift"],
        "model_tag": ["CTSF"] * 4,
        "gc_kernel_tod_dcor": [0.3, 0.25, 0.32, 0.27],
        "gc_feat_tod_dcor": [0.4, 0.35, 0.42, 0.37],
        "gc_feat_tod_r2": [0.5, 0.45, 0.52, 0.47],
    })
    results_data.to_csv(results_csv, index=False)
    
    try:
        rebuild_w3_perturb_delta_bar(results_csv, delta_detail, delta_summary)
        assert delta_detail.exists(), "Delta detail file should be created"
        assert delta_summary.exists(), "Delta summary file should be created"
        print("✓ rebuild_w3_perturb_delta_bar works")
    except Exception as e:
        print(f"✗ rebuild_w3_perturb_delta_bar failed: {e}")
        import traceback
        traceback.print_exc()
        exit(1)

print("\n✓ All function tests passed!")
```

**Step 3.5**: 실제 실험 스모크 테스트

```bash
# ETTm2, none 모드로 간단 실행
python main.py --experiment W3 --dataset ETTm2 --horizon 96 --seed 42 --mode none
```

---

## 수정 세부 사항

### 수정 위치 요약

| 순번 | Line | 함수 | 수정 내용 |

|------|------|------|-----------|

| 1 | 390 | `rebuild_w3_forest_summary` | `_atomic_write_csv(out, _ensure_dir(summary_csv))` → `_atomic_write_csv(summary_csv, out)` |

| 2 | 407-409 | `rebuild_w3_perturb_delta_bar._emit_empties` | `_atomic_write_csv(df, _ensure_dir(detail_csv))` → `_atomic_write_csv(detail_csv, df)` |

| 3 | 411-413 | `rebuild_w3_perturb_delta_bar._emit_empties` | `_atomic_write_csv(df, _ensure_dir(summary_csv))` → `_atomic_write_csv(summary_csv, df)` |

| 4 | 482 | `rebuild_w3_perturb_delta_bar` | `_atomic_write_csv(D, _ensure_dir(detail_csv))` → `_atomic_write_csv(detail_csv, D)` |

| 5 | 489 | `rebuild_w3_perturb_delta_bar` | `_atomic_write_csv(S, _ensure_dir(summary_csv))` → `_atomic_write_csv(summary_csv, S)` |

### _ensure_dir 중복 호출 제거 (선택)

각 수정에서 `_ensure_dir()`를 제거할 수 있습니다. 이유:

- `_atomic_write_csv` 내부(line 24)에서 이미 `path = _ensure_dir(path)` 호출
- 외부에서 호출하는 것은 중복이지만 해롭지는 않음
- 코드를 더 간결하게 만들기 위해 제거 권장

**예시**:

```python
# 원래:
_atomic_write_csv(out, _ensure_dir(summary_csv))

# 수정 (권장):
_atomic_write_csv(summary_csv, out)

# 대신 (작동하지만 중복):
_atomic_write_csv(_ensure_dir(summary_csv), out)
```

---

## 예상 결과

### 수정 전

- `rebuild_w3_forest_summary` 실행 시: `AttributeError` 또는 `TypeError`
- `rebuild_w3_perturb_delta_bar` 실행 시: `AttributeError` 또는 `TypeError`
- W3 실험 후 요약 생성 완전 실패
- **에러 메시지**: `'DataFrame' object has no attribute 'parent'` 또는 `expected str, bytes or os.PathLike object, not DataFrame`

### 수정 후

- 모든 함수가 정상 실행
- 요약 CSV 파일들이 올바르게 생성
- W3 실험 전체 파이프라인 정상 작동

---

## 예상 소요 시간

- Phase 1 (rebuild_w3_forest_summary 수정): 5분
- Phase 2 (rebuild_w3_perturb_delta_bar 수정): 10분
- Phase 3 (검증): 15분
- **총: 30분**

---

## 주의사항

1. **모든 5개 호출을 반드시 수정**해야 합니다. 하나라도 빠뜨리면 해당 함수가 실패합니다.

2. **매개변수 순서는 `(path, df)`**로 통일합니다. 이것은 pandas의 `to_csv(path, ...)` 관례와 일치하며 더 직관적입니다.

3. **_ensure_dir 중복 호출은 제거 권장**하지만 필수는 아닙니다. 함수 내부에서 이미 호출되므로 외부 호출은 불필요합니다.

4. **검증 단계는 필수**입니다. 단위 테스트와 함수 테스트를 모두 실행하여 수정이 올바른지 확인해야 합니다.

5. **이 버그는 플랜 작성 시 누락되었던 문제**입니다. 플랜대로 중복 함수를 제거했지만, 호출 코드를 새로운 함수 시그니처에 맞게 통일하지 않았습니다.

---

## 추가 권장 사항

### 향후 예방을 위한 개선

1. **타입 힌팅 강화**:
```python
def _atomic_write_csv(path: str | Path, df: pd.DataFrame) -> None:
    """
    Atomic CSV write (single temp file, then replace).
    
    Args:
        path: Output CSV file path (FIRST parameter)
        df: DataFrame to write (SECOND parameter)
    """
    path = _ensure_dir(path)
    tmp = path.with_suffix(path.suffix + ".tmp")
    df.to_csv(tmp, index=False)
    tmp.replace(path)
```

2. **mypy 사용**: 정적 타입 체크로 이러한 실수를 자동 감지
```bash
mypy utils/experiment_plotting_metrics/w3_plotting_metrics.py
```

3. **단위 테스트 작성**: 각 함수에 대한 테스트를 작성하여 시그니처 불일치를 조기에 발견